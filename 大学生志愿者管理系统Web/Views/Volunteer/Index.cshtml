@model IEnumerable<DAL.ActivityT>
@{
    ViewBag.Title = "志愿者活动广场";
    var ongoingActivities = Model.Where(a => a.status == "进行中").ToList();
}

<div class="container">
    <!-- 用户信息部分 -->
    <div class="row">
        <div class="col-md-8">
            <h2>志愿者活动广场</h2>
        </div>
        <div class="col-md-4 text-right">
            @if (Session["Username"] != null)
            {
                <div class="volunteer-info">
                    <p>
                        <span class="label label-success">已登录</span>
                        欢迎, <strong>@Session["Username"]</strong>
                    </p>
                    @if (ViewBag.VolunteerHours != null)
                    {
                        <p>志愿时长: <span class="badge" style="color:black">@ViewBag.VolunteerHours 小时</span></p>
                    }
                </div>
            }
            else
            {
                <p>
                    <a href="@Url.Action("Login", "Account")" class="btn btn-primary">
                        <span class="glyphicon glyphicon-log-in"></span> 登录
                    </a>
                    <a href="@Url.Action("Register", "Account")" class="btn btn-default">
                        <span class="glyphicon glyphicon-user"></span> 注册
                    </a>
                </p>
            }
        </div>
    </div>

    <!-- 轮播图展示最新活动 -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="glyphicon glyphicon-fire"></span> 推荐活动</h3>
                </div>
                <div class="panel-body">
                    @if (ongoingActivities != null && ongoingActivities.Any())
                    {
                        <div id="activityCarousel" class="carousel slide" data-ride="carousel">
                            <!-- 指示器 -->
                            <ol class="carousel-indicators">
                                @for (int i = 0; i < Math.Min(ongoingActivities.Count, 5); i++)
                                {
                                    <li data-target="#activityCarousel" data-slide-to="@i" class="@(i == 0 ? "active" : "")"></li>
                                }
                            </ol>

                            <!-- 轮播项目 -->
                            <div class="carousel-inner" role="listbox">
                                @{
                                    var featuredActivities = ongoingActivities.Take(5).ToList();
                                    for (int i = 0; i < featuredActivities.Count; i++)
                                    {
                                        var activity = featuredActivities[i];
                                        <div class="item @(i == 0 ? "active" : "")">
                                            <div class="carousel-content">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <!-- 修改轮播图部分的图片显示 -->
                                                        @if (!string.IsNullOrEmpty(activity.Image) && !activity.Image.Contains("暂无图片"))
                                                        {
                                                            <img src="@Url.Action("Activity", "Image", new { path = activity.Image })"
                                                                 alt="活动图片" class="img-responsive carousel-img"
                                                                 onerror="this.src='@Url.Content("~/Content/Images/暂无图片.gif")';" />
                                                        }
                                                        else
                                                        {
                                                            <img src="@Url.Content("~/Content/Images/暂无图片.gif")" alt="暂无图片" class="img-responsive carousel-img" />
                                                        }
                                                    </div>
                                                    <div class="col-md-8">
                                                        <h3>
                                                            <a href="@Url.Action("ActivityDetails", new { id = activity.activity_ID })">
                                                                @activity.activity_Name
                                                            </a>
                                                        </h3>
                                                        <p><strong>类型:</strong> @activity.activity_type</p>
                                                        <p><strong>时间:</strong> @activity.addtime.ToString("yyyy-MM-dd") 至 @activity.stoptime.ToString("yyyy-MM-dd")</p>
                                                        <p><strong>地点:</strong> @activity.place</p>
                                                        <p><strong>需要人数:</strong> @activity.renshu 名</p>
                                                        <p class="carousel-description">
                                                            @(string.IsNullOrEmpty(activity.descn) ? "暂无描述" :
                                                                (activity.descn.Length > 150 ? activity.descn.Substring(0, 150) + "..." : activity.descn))
                                                        </p>
                                                        <p>
                                                            <a href="@Url.Action("ActivityDetails", new { id = activity.activity_ID })" class="btn btn-info">
                                                                <span class="glyphicon glyphicon-info-sign"></span> 详情
                                                            </a>
                                                            <a href="@Url.Action("ApplyActivity", new { id = activity.activity_ID })" class="btn btn-primary">
                                                                <span class="glyphicon glyphicon-ok"></span> 立即申请
                                                            </a>
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>

                            <!-- 左右控制按钮 -->
                            <a class="left carousel-control" href="#activityCarousel" role="button" data-slide="prev">
                                <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                                <span class="sr-only">上一个</span>
                            </a>
                            <a class="right carousel-control" href="#activityCarousel" role="button" data-slide="next">
                                <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                                <span class="sr-only">下一个</span>
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <span class="glyphicon glyphicon-info-sign"></span> 暂无进行中的活动
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- 搜索和筛选部分 -->
    <div class="row search-panel">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="row">
                        <!-- 按名称搜索 -->
                        <div class="col-md-5">
                            @using (Html.BeginForm("Search", "Volunteer", FormMethod.Get, new { @class = "form-inline" }))
                            {
                                <div class="form-group">
                                    <div class="input-group">
                                        <input type="text" name="keyword" class="form-control" placeholder="活动名称关键词" />
                                        <span class="input-group-btn">
                                            <button type="submit" class="btn btn-primary">
                                                <span class="glyphicon glyphicon-search"></span> 搜索
                                            </button>
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- 按类型筛选 -->
                        <div class="col-md-5">
                            @using (Html.BeginForm("Filter", "Volunteer", FormMethod.Get, new { @class = "form-inline" }))
                            {
                                <div class="form-group">
                                    <select name="activityType" class="form-control">
                                        <option value="">--选择活动类型--</option>
                                        <option value="教育类">教育类</option>
                                        <option value="社区发展类">社区发展类</option>
                                        <option value="卫生与医疗类">卫生与医疗类</option>
                                        <option value="环境保护类">环境保护类</option>
                                        <option value="动物保护类">动物保护类</option>
                                        <option value="紧急救援类">紧急救援类</option>
                                    </select>
                                    <button type="submit" class="btn btn-info">
                                        <span class="glyphicon glyphicon-filter"></span> 筛选
                                    </button>
                                </div>
                            }
                        </div>

                        <!-- 刷新按钮 -->
                        <div class="col-md-2 text-right">
                            <a href="@Url.Action("Index", "Volunteer")" class="btn btn-default">
                                <span class="glyphicon glyphicon-refresh"></span> 刷新
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 功能按钮区 -->
    <div class="row button-panel">
        <div class="col-md-12">
            <div class="btn-group">
                <a href="@Url.Action("MyApplications", "Volunteer")" class="btn btn-primary">
                    <span class="glyphicon glyphicon-list"></span> 我的申请
                </a>
                <a href="@Url.Action("GetVolunteerHours", "Volunteer")" class="btn btn-success">
                    <span class="glyphicon glyphicon-time"></span> 查看志愿时长
                </a>
                <a href="@Url.Action("SelfCheck", "Volunteer")" class="btn btn-info">
                    <span class="glyphicon glyphicon-user"></span> 个人信息
                </a>
                <a href="@Url.Action("ApplyIdentify", "Volunteer")" class="btn btn-warning">
                    <span class="glyphicon glyphicon-certificate"></span> 申请志愿者证
                </a>
            </div>
        </div>
    </div>

    <!-- 活动列表 -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">进行中的志愿活动</h3>
                </div>
                <div class="panel-body">
                    <div class="activity-slider">
                        @if (ongoingActivities != null && ongoingActivities.Any())
                        {
                            <div class="slider-container">
                                <button class="slider-prev"><span class="glyphicon glyphicon-chevron-left"></span></button>
                                <div class="slider-wrapper">
                                    @foreach (var activity in ongoingActivities)
                                    {
                                        <div class="activity-card" data-id="@activity.activity_ID">
                                            <div class="activity-image">
                                                <!-- 修改活动卡片部分的图片显示 -->
                                                @if (!string.IsNullOrEmpty(activity.Image) && !activity.Image.Contains("暂无图片"))
                                                {
                                                    <img src="@Url.Action("Activity", "Image", new { path = activity.Image })"
                                                         alt="活动图片" class="img-responsive"
                                                         onerror="this.src='@Url.Content("~/Content/Images/暂无图片.gif")';" />
                                                }
                                                else
                                                {
                                                    <img src="@Url.Content("~/Content/Images/暂无图片.gif")" alt="暂无图片" class="img-responsive" />
                                                }
                                            </div>
                                            <div class="activity-content">
                                                <h4>@activity.activity_Name</h4>
                                                <p class="activity-type"><span class="label label-info">@activity.activity_type</span></p>
                                                <p class="activity-date">
                                                    <span class="glyphicon glyphicon-calendar"></span>
                                                    @activity.addtime.ToString("yyyy-MM-dd")
                                                </p>
                                                <p class="activity-place">
                                                    <span class="glyphicon glyphicon-map-marker"></span>
                                                    @activity.place
                                                </p>
                                                <p class="activity-people">
                                                    <span class="glyphicon glyphicon-user"></span> 需要 @activity.renshu 人
                                                </p>
                                                <div class="activity-buttons">
                                                    <a href="@Url.Action("ActivityDetails", "Volunteer", new { id = activity.activity_ID })" class="btn btn-info btn-sm">
                                                        <span class="glyphicon glyphicon-info-sign"></span> 详情
                                                    </a>
                                                    <a href="@Url.Action("ApplyActivity", "Volunteer", new { id = activity.activity_ID })" class="btn btn-primary btn-sm">
                                                        <span class="glyphicon glyphicon-ok"></span> 申请
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <button class="slider-next"><span class="glyphicon glyphicon-chevron-right"></span></button>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <span class="glyphicon glyphicon-info-sign"></span> 暂无进行中的活动
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* 基本样式 */
    .search-panel {
        margin-bottom: 15px;
    }

    .button-panel {
        margin-bottom: 20px;
    }

    .volunteer-info {
        background-color: #f9f9f9;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #eee;
    }

    /* 轮播图样式 */
    .carousel-content {
        background: #f8f8f8;
        padding: 20px;
        border-radius: 5px;
        min-height: 350px;
    }

    .carousel-img {
        max-height: 300px;
        margin: 0 auto;
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .carousel-description {
        height: 60px;
        overflow: hidden;
    }

    /* 活动卡片滑块样式 */
    .activity-slider {
        width: 100%;
        overflow: hidden;
        position: relative;
    }

    .slider-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
    }

    .slider-wrapper {
        display: flex;
        overflow-x: hidden;
        scroll-behavior: smooth;
        gap: 15px;
        padding: 10px 0;
        flex-grow: 1;
    }

    .slider-prev, .slider-next {
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
    }

        .slider-prev:hover, .slider-next:hover {
            background: rgba(0, 0, 0, 0.8);
        }

    .slider-prev {
        margin-right: 10px;
    }

    .slider-next {
        margin-left: 10px;
    }

    .activity-card {
        flex: 0 0 250px;
        border: 1px solid #ddd;
        border-radius: 5px;
        overflow: hidden;
        background: white;
        transition: transform 0.3s;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

    .activity-image {
        height: 150px;
        overflow: hidden;
    }

        .activity-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .activity-content {
        padding: 10px;
    }

        .activity-content h4 {
            margin-top: 0;
            height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    .activity-type, .activity-date, .activity-place, .activity-people {
        margin: 5px 0;
        font-size: 12px;
    }

    .activity-buttons {
        margin-top: 10px;
        text-align: center;
    }
</style>

@section scripts {
    <script>
        $(document).ready(function () {
            // 轮播图自动播放设置
            $('#activityCarousel').carousel({
                interval: 5000
            });

            // 活动卡片滑块功能
            const sliderWrapper = $('.slider-wrapper');
            const cardWidth = 265; // 卡片宽度 + 间距
            const visibleCards = Math.floor(sliderWrapper.width() / cardWidth);

            $('.slider-prev').click(function () {
                sliderWrapper.animate({
                    scrollLeft: '-=' + (cardWidth * visibleCards)
                }, 300);
            });

            $('.slider-next').click(function () {
                sliderWrapper.animate({
                    scrollLeft: '+=' + (cardWidth * visibleCards)
                }, 300);
            });

            // 点击活动卡片跳转到详情页
            $('.activity-card').click(function (e) {
                // 如果点击的是按钮，不执行卡片的点击事件
                if ($(e.target).closest('.activity-buttons').length === 0) {
                    const activityId = $(this).data('id');
                    window.location.href = '@Url.Action("ActivityDetails", "Volunteer")/' + activityId;
                }
            });

            // 阻止按钮点击事件冒泡
            $('.activity-buttons a').click(function (e) {
                e.stopPropagation();
            });
        });
    </script>
}